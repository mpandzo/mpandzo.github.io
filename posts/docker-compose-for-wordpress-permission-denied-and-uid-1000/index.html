<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docker compose for WordPress - Permission denied and uid 1000</title>
    <meta name="description" content="Unable to upgrade WordPress due to - \&quot;failed to open stream - Permission denied error\&quot;">
    <meta name="generator" content="Eleventy v1.0.1">

    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/prism-base16-monokai.dark.css">
    <link rel="stylesheet" href="/css/prism-diff.css">
    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Mirza Pandzo">
    <link rel="alternate" href="/feed/feed.json" type="application/json" title="Mirza Pandzo">
    <link rel="canonical" href="https://mirzapandzo.com/posts/docker-compose-for-wordpress-permission-denied-and-uid-1000/" />

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-NZ0KLGD1CV"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-NZ0KLGD1CV');
    </script>
  </head>
  <body>
    <header>
      <div class="container">
        <div class="home"><a href="/">Mirza Pandzo</a></div>
        <ul class="nav">
          <li class="nav-item"><a href="/posts/">Posts</a></li>
          <li class="nav-item"><a href="/tags/">Tags</a></li>
        </ul>
      </div>
    </header>

    <main class="tmpl-post container">
      <h1>Docker compose for WordPress - Permission denied and uid 1000</h1>

<div class="meta">
  <div class="published">
    Published on
    <time datetime="2022-10-26">26 Oct 2022</time>
  </div>
  <span class="separator">-</span>
  <div class="tags"><a href="/tags/wordpress/" class="post-tag">WordPress</a><a href="/tags/docker-compose/" class="post-tag">Docker compose</a>
  </div>
</div>

<p>I've got a simple docker-compose.yml file for working on WordPress projects locally.</p>
<pre class="language-yml"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"3.5"</span><br><br><span class="token key atrule">services</span><span class="token punctuation">:</span><br><br>  <span class="token key atrule">mysql</span><span class="token punctuation">:</span><br>    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> wp<span class="token punctuation">-</span>mysql<br>    <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><br>    <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">5.7</span><br>    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always<br>    <span class="token key atrule">environment</span><span class="token punctuation">:</span><br>      <span class="token key atrule">MYSQL_ROOT_PASSWORD</span><span class="token punctuation">:</span> root<br>      <span class="token key atrule">MYSQL_DATABASE</span><span class="token punctuation">:</span> wordpress<br>      <span class="token key atrule">MYSQL_USER</span><span class="token punctuation">:</span> wordpress<br>      <span class="token key atrule">MYSQL_PASSWORD</span><span class="token punctuation">:</span> wordpress<br><br>  <span class="token key atrule">wordpress</span><span class="token punctuation">:</span><br>    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> wp<span class="token punctuation">-</span>wordpress<br>    <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><br>    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> mysql<br>    <span class="token key atrule">image</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">:</span>latest<br>    <span class="token key atrule">volumes</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> ./<span class="token punctuation">:</span>/var/www/html<br>    <span class="token key atrule">ports</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> <span class="token string">"8080:80"</span><br>    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always<br><br>  <span class="token key atrule">phpmyadmin</span><span class="token punctuation">:</span><br>    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> wp<span class="token punctuation">-</span>phpmyadmin<br>    <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><br>    <span class="token key atrule">image</span><span class="token punctuation">:</span> phpmyadmin/phpmyadmin<br>    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> mysql<br>    <span class="token key atrule">ports</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> 8181<span class="token punctuation">:</span><span class="token number">80</span><br>    <span class="token key atrule">environment</span><span class="token punctuation">:</span><br>      <span class="token key atrule">MYSQL_USERNAME</span><span class="token punctuation">:</span> root<br>      <span class="token key atrule">MYSQL_ROOT_PASSWORD</span><span class="token punctuation">:</span> root<br>      <span class="token key atrule">MYSQL_PORT_3306_TCP_ADDR</span><span class="token punctuation">:</span> mysql<br>      <span class="token key atrule">PMA_HOST</span><span class="token punctuation">:</span> mysql</code></pre>
<p>I've used this without any issues on my MacBook Air by running <code>docker-compose up</code>.</p>
<p>When I recently tried to do the same on a windows machine running WSL (Windows Subsystem for Linux) and I tried to upgrade to the latest version of WordPress, I faced the following error in WordPress dashboard:</p>
<pre class="language-text"><code class="language-text">Update WordPress<br>Downloading update from https://downloads.wordpress.org/release/wordpress-6.0.3-new-bundled.zip…<br><br>The authenticity of wordpress-6.0.3-new-bundled.zip could not be verified as no signature was found.<br><br>Unpacking the update…<br><br>Warning: copy(/var/www/html/wp-admin/includes/update-core.php): failed to open stream: Permission denied in /var/www/html/wp-admin/includes/class-wp-filesystem-direct.php on line 309<br>The update cannot be installed because we will be unable to copy some files. This is usually due to inconsistent file permissions.: wp-admin/includes/update-core.php<br><br>Installation failed.</code></pre>
<p>In order to see what permissions are set up inside the /var/www/html that may be causing this, I bashed into the container with the following command:</p>
<pre class="language-shell"><code class="language-shell"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> -ti wp-wordpress <span class="token function">bash</span></code></pre>
<p>The result and subsequent <code>ls -la</code> listing looks like this:</p>
<pre class="language-shell"><code class="language-shell">root@6eaac5e083f5:/var/www/html<span class="token comment"># ls -la</span><br>drwxr-xr-x  <span class="token number">8</span> <span class="token number">1000</span> <span class="token number">1000</span>   <span class="token number">4096</span> Oct <span class="token number">26</span> 01:39 <span class="token builtin class-name">.</span><br>drwxr-xr-x  <span class="token number">1</span> root root   <span class="token number">4096</span> Oct  <span class="token number">5</span> 07:09 <span class="token punctuation">..</span><br>-rw-r--r--  <span class="token number">1</span> <span class="token number">1000</span> <span class="token number">1000</span>   <span class="token number">1051</span> Aug <span class="token number">25</span>  <span class="token number">2021</span> .htaccess<br>-rw-r--r--  <span class="token number">1</span> <span class="token number">1000</span> <span class="token number">1000</span>   <span class="token number">1812</span> Oct <span class="token number">26</span> 01:39 docker-compose.yml<br>-rw-r--r--  <span class="token number">1</span> <span class="token number">1000</span> <span class="token number">1000</span>    <span class="token number">405</span> Apr <span class="token number">30</span>  <span class="token number">2021</span> index.php<br>-rw-r--r--  <span class="token number">1</span> <span class="token number">1000</span> <span class="token number">1000</span>  <span class="token number">19915</span> Aug <span class="token number">25</span>  <span class="token number">2021</span> license.txt<br>-rw-r--r--  <span class="token number">1</span> <span class="token number">1000</span> <span class="token number">1000</span>   <span class="token number">7346</span> Oct <span class="token number">20</span>  <span class="token number">2021</span> readme.html<br>-rw-r--r--  <span class="token number">1</span> <span class="token number">1000</span> <span class="token number">1000</span>   <span class="token number">5626</span> Apr <span class="token number">30</span>  <span class="token number">2021</span> readme.md<br>-rw-r--r--  <span class="token number">1</span> <span class="token number">1000</span> <span class="token number">1000</span>   <span class="token number">7165</span> Apr <span class="token number">30</span>  <span class="token number">2021</span> wp-activate.php<br>drwxr-xr-x  <span class="token number">9</span> <span class="token number">1000</span> <span class="token number">1000</span>   <span class="token number">4096</span> Aug <span class="token number">25</span>  <span class="token number">2021</span> wp-admin<br>-rw-r--r--  <span class="token number">1</span> <span class="token number">1000</span> <span class="token number">1000</span>    <span class="token number">351</span> Apr <span class="token number">30</span>  <span class="token number">2021</span> wp-blog-header.php<br>-rw-r--r--  <span class="token number">1</span> <span class="token number">1000</span> <span class="token number">1000</span>   <span class="token number">2328</span> Apr <span class="token number">30</span>  <span class="token number">2021</span> wp-comments-post.php<br>-rw-r--r--  <span class="token number">1</span> <span class="token number">1000</span> <span class="token number">1000</span>   <span class="token number">3004</span> Aug <span class="token number">25</span>  <span class="token number">2021</span> wp-config-sample.php<br>-rw-r--r--  <span class="token number">1</span> <span class="token number">1000</span> <span class="token number">1000</span>   <span class="token number">5907</span> Jun <span class="token number">30</span>  <span class="token number">2021</span> wp-config.php<br>drwxrwxrwx  <span class="token number">6</span> <span class="token number">1000</span> <span class="token number">1000</span>   <span class="token number">4096</span> Jun <span class="token number">30</span>  <span class="token number">2021</span> wp-content<br>-rw-r--r--  <span class="token number">1</span> <span class="token number">1000</span> <span class="token number">1000</span>   <span class="token number">3939</span> Apr <span class="token number">30</span>  <span class="token number">2021</span> wp-cron.php<br>drwxr-xr-x <span class="token number">25</span> <span class="token number">1000</span> <span class="token number">1000</span>  <span class="token number">12288</span> Aug <span class="token number">25</span>  <span class="token number">2021</span> wp-includes<br>-rw-r--r--  <span class="token number">1</span> <span class="token number">1000</span> <span class="token number">1000</span>   <span class="token number">2496</span> Apr <span class="token number">30</span>  <span class="token number">2021</span> wp-links-opml.php<br>-rw-r--r--  <span class="token number">1</span> <span class="token number">1000</span> <span class="token number">1000</span>   <span class="token number">3900</span> Aug <span class="token number">25</span>  <span class="token number">2021</span> wp-load.php<br>-rw-r--r--  <span class="token number">1</span> <span class="token number">1000</span> <span class="token number">1000</span>  <span class="token number">45463</span> Aug <span class="token number">25</span>  <span class="token number">2021</span> wp-login.php<br>-rw-r--r--  <span class="token number">1</span> <span class="token number">1000</span> <span class="token number">1000</span>   <span class="token number">8509</span> Apr <span class="token number">30</span>  <span class="token number">2021</span> wp-mail.php<br>-rw-r--r--  <span class="token number">1</span> <span class="token number">1000</span> <span class="token number">1000</span>  <span class="token number">22297</span> Aug <span class="token number">25</span>  <span class="token number">2021</span> wp-settings.php<br>-rw-r--r--  <span class="token number">1</span> <span class="token number">1000</span> <span class="token number">1000</span>  <span class="token number">31693</span> Aug <span class="token number">25</span>  <span class="token number">2021</span> wp-signup.php<br>-rw-r--r--  <span class="token number">1</span> <span class="token number">1000</span> <span class="token number">1000</span>   <span class="token number">4747</span> Apr <span class="token number">30</span>  <span class="token number">2021</span> wp-trackback.php<br>-rw-r--r--  <span class="token number">1</span> <span class="token number">1000</span> <span class="token number">1000</span>   <span class="token number">3236</span> Apr <span class="token number">30</span>  <span class="token number">2021</span> xmlrpc.php<br>root@6eaac5e083f5:/var/www/html<span class="token comment">#</span></code></pre>
<p>From the above, I gathered that the files and folders were owned by user:group 1000:1000. Further reading lead to the finding that on most Linux systems UID:GUID of 1000:1000 is used for the first non-system account created. In addition, when volumes are mounted docker sets UID:GUID for volume mounted files and folders to the same. <a href="https://github.com/moby/moby/issues/22114">[1]</a>, <a href="https://github.com/davidalger/warden/issues/155">[2]</a>.</p>
<p>As a result, when the apache's www-data user tries to modify files or folders owned by 1000:1000 we face the issue described at the beginning of this post.</p>
<p>To get around this I switched to building my WordPress image with the help of a Dockerfile where I change ownership of the files and folders to www-data:www-data.</p>
<p>My modified docker-compose.yml file:</p>
<pre class="language-yml"><code class="language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"3.5"</span><br><br><span class="token key atrule">services</span><span class="token punctuation">:</span><br><br>  <span class="token key atrule">mysql</span><span class="token punctuation">:</span><br>    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> wp<span class="token punctuation">-</span>mysql<br>    <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><br>    <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">5.7</span><br>    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always<br>    <span class="token key atrule">environment</span><span class="token punctuation">:</span><br>      <span class="token key atrule">MYSQL_ROOT_PASSWORD</span><span class="token punctuation">:</span> root<br>      <span class="token key atrule">MYSQL_DATABASE</span><span class="token punctuation">:</span> wordpress<br>      <span class="token key atrule">MYSQL_USER</span><span class="token punctuation">:</span> wordpress<br>      <span class="token key atrule">MYSQL_PASSWORD</span><span class="token punctuation">:</span> wordpress<br><br>  <span class="token key atrule">wordpress</span><span class="token punctuation">:</span><br>    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> wp<span class="token punctuation">-</span>wordpress<br>    <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><br>    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> mysql<br>    <span class="token key atrule">image</span><span class="token punctuation">:</span> local<span class="token punctuation">-</span>wordpress<span class="token punctuation">:</span>latest<br>    <span class="token key atrule">build</span><span class="token punctuation">:</span><br>      <span class="token key atrule">context</span><span class="token punctuation">:</span> .<br>      <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> Dockerfile.WordPress<br>    <span class="token key atrule">volumes</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> ./<span class="token punctuation">:</span>/var/www/html<br>    <span class="token key atrule">ports</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> <span class="token string">"8080:80"</span><br>    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always<br><br>  <span class="token key atrule">phpmyadmin</span><span class="token punctuation">:</span><br>    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> wp<span class="token punctuation">-</span>phpmyadmin<br>    <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><br>    <span class="token key atrule">image</span><span class="token punctuation">:</span> phpmyadmin/phpmyadmin<br>    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> mysql<br>    <span class="token key atrule">ports</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> 8181<span class="token punctuation">:</span><span class="token number">80</span><br>    <span class="token key atrule">environment</span><span class="token punctuation">:</span><br>      <span class="token key atrule">MYSQL_USERNAME</span><span class="token punctuation">:</span> root<br>      <span class="token key atrule">MYSQL_ROOT_PASSWORD</span><span class="token punctuation">:</span> root<br>      <span class="token key atrule">MYSQL_PORT_3306_TCP_ADDR</span><span class="token punctuation">:</span> mysql<br>      <span class="token key atrule">PMA_HOST</span><span class="token punctuation">:</span> mysql</code></pre>
<p>Dockerfile (Dockerfile.WordPress) thanks to <a href="https://stackoverflow.com/questions/55620273/docker-php-fpm-running-as-www-data">[3]</a>:</p>
<pre class="language-dockerfile"><code class="language-dockerfile"><span class="token instruction"><span class="token keyword">FROM</span> wordpress:latest</span><br><br><span class="token instruction"><span class="token keyword">ARG</span> UNAME=www-data</span><br><span class="token instruction"><span class="token keyword">ARG</span> UGROUP=www-data</span><br><span class="token instruction"><span class="token keyword">ARG</span> UID=1000</span><br><span class="token instruction"><span class="token keyword">ARG</span> GID=1000</span><br><span class="token instruction"><span class="token keyword">RUN</span> usermod  --uid <span class="token variable">$UID</span> <span class="token variable">$UNAME</span></span><br><span class="token instruction"><span class="token keyword">RUN</span> groupmod --gid <span class="token variable">$GID</span> <span class="token variable">$UGROUP</span></span></code></pre>

<div class="post-nav">
  <ul><li><strong>Previous:</strong> <a href="/posts/the-tailwind-dilemma-utility-first-vs-semantic-css/">The tailwind dilemma - utility first vs semantic CSS</a></li><li><strong>Next:</strong> <a href="/posts/amazon-linux-2-elasticbeanstalk-and-apache-httpd/">Amazon Linux 2 ElasticBeanstalk and Apache HTTPD</a></li>
  </ul>
</div>
<h3>Recent posts</h3>
<ul class="recentposts">
<li><a href="/posts/sst-cannot-use-graphqlscalartype-boolean-from-another-module-or-realm/">SST - Cannot use GraphQLScalarType &quot;Boolean&quot; from another module or realm</a></li>
<li><a href="/posts/the-power-of-laziness-automating-some-text-entry-work/">The power of laziness - automating some text entry work</a></li>
<li><a href="/posts/deploying-pocketbase-to-a-digital-ocean-droplet/">Deploying PocketBase to a Digital Ocean droplet</a></li>
<li><a href="/posts/the-tailwind-dilemma-utility-first-vs-semantic-css/">The tailwind dilemma - utility first vs semantic CSS</a></li>
<li><a href="/posts/docker-compose-for-wordpress-permission-denied-and-uid-1000/">Docker compose for WordPress - Permission denied and uid 1000</a></li>
<li><a href="/posts/amazon-linux-2-elasticbeanstalk-and-apache-httpd/">Amazon Linux 2 ElasticBeanstalk and Apache HTTPD</a></li>
<li><a href="/posts/elasticbeanstalk-php-settings-and-the-frustratingly-confusing-guide-to-eb-deploy/">ElasticBeanstalk, PHP settings and the frustratingly confusing guide to eb deploy</a></li>
<li><a href="/posts/serverless-architecture-real-world-examples/">Serverless Architecture - Real world examples</a></li>
</ul>

    </main>

    <footer role="contentinfo">
      <div class="container">
        <div class="left">&copy 2023 mirzapandzo.com</div>
        <div class="right">Built with <a href="https://github.com/11ty/eleventy-base-blog">11ty</a>
      </div>
    </footer>

    <!-- Current page: /posts/docker-compose-for-wordpress-permission-denied-and-uid-1000/ -->
  </body>
</html>
